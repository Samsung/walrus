# default set of each flag
SET (WALRUS_CXXFLAGS -fno-rtti) # build walrus without rtti
SET (WALRUS_LDFLAGS)
SET (WALRUS_DEFINITIONS)
SET (WALRUS_THIRDPARTY_CFLAGS)

SET (WALRUS_BUILD_32BIT OFF)
SET (WALRUS_BUILD_64BIT OFF)
SET (WALRUS_BUILD_64BIT_LARGE OFF)

IF (${WALRUS_HOST} STREQUAL "linux")
    # default set of LDFLAGS
    SET (WALRUS_LDFLAGS -lpthread -lrt -Wl,--gc-sections)
    IF ((${WALRUS_ARCH} STREQUAL "x64") OR (${WALRUS_ARCH} STREQUAL "x86_64"))
        SET (WALRUS_BUILD_64BIT ON)
    ELSEIF ((${WALRUS_ARCH} STREQUAL "x86") OR (${WALRUS_ARCH} STREQUAL "i686"))
        SET (WALRUS_BUILD_32BIT ON)
        SET (WALRUS_CXXFLAGS ${WALRUS_CXXFLAGS} -m32 -mfpmath=sse -msse -msse2)
        SET (WALRUS_LDFLAGS ${WALRUS_LDFLAGS} -m32)
        SET (WALRUS_THIRDPARTY_CFLAGS ${WALRUS_THIRDPARTY_CFLAGS} -m32)
    ELSEIF (${WALRUS_ARCH} STREQUAL "arm")
        SET (WALRUS_BUILD_32BIT ON)
    ELSEIF (${WALRUS_ARCH} STREQUAL "aarch64")
        SET (WALRUS_BUILD_64BIT ON)
    ELSE()
        MESSAGE (FATAL_ERROR ${WALRUS_ARCH} " is unsupported")
    ENDIF()
ELSEIF (${WALRUS_HOST} STREQUAL "tizen_obs")
    # default set of LDFLAGS
    SET (WALRUS_LDFLAGS -lpthread -lrt -Wl,--gc-sections)
    SET (WALRUS_DEFINITIONS -DWALRUS_TIZEN)
    IF ((${WALRUS_ARCH} STREQUAL "x64") OR (${WALRUS_ARCH} STREQUAL "x86_64"))
    ELSEIF ((${WALRUS_ARCH} STREQUAL "x86") OR (${WALRUS_ARCH} STREQUAL "i686"))
        SET (WALRUS_BUILD_32BIT ON)
        SET (WALRUS_CXXFLAGS ${WALRUS_CXXFLAGS} -m32 -mfpmath=sse -msse -msse2)
        SET (WALRUS_LDFLAGS ${WALRUS_LDFLAGS} -m32)
        SET (WALRUS_THIRDPARTY_CFLAGS ${WALRUS_THIRDPARTY_CFLAGS} -m32)
    ELSEIF (${WALRUS_ARCH} STREQUAL "arm")
        SET (WALRUS_BUILD_32BIT ON)
        SET (WALRUS_CXXFLAGS_DEBUG -O1)
        SET (WALRUS_CXXFLAGS_RELEASE -O2)
    ELSEIF (${WALRUS_ARCH} STREQUAL "aarch64")
        SET (WALRUS_BUILD_64BIT ON)
    ELSE()
        MESSAGE (FATAL_ERROR ${WALRUS_ARCH} " is unsupported")
    ENDIF()
ELSEIF (${WALRUS_HOST} STREQUAL "android")
    SET (WALRUS_DEFINITIONS -DANDROID=1 -DWALRUS_ANDROID=1)
    SET (WALRUS_THIRDPARTY_CFLAGS ${WALRUS_THIRDPARTY_CFLAGS} -mstackrealign)
    SET (WALRUS_CXXFLAGS -mstackrealign)
    # android + clang -O2 option causes crash (gc cannot scan stack correctly I guess)
    SET (WALRUS_CXXFLAGS_RELEASE -Oz)
    IF (${WALRUS_ARCH} STREQUAL "armeabi-v7a")
        SET (WALRUS_BUILD_32BIT ON)
        SET (WALRUS_LDFLAGS -fPIE -pie -march=armv7-a -Wl,--fix-cortex-a8 -llog -Wl,--gc-sections)
    ELSEIF ((${WALRUS_ARCH} STREQUAL "arm64-v8a") OR (${WALRUS_ARCH} STREQUAL "aarch64"))
        SET (WALRUS_BUILD_64BIT_LARGE ON)
        SET (WALRUS_LDFLAGS -fPIE -pie -llog -Wl,--gc-sections)
    ELSEIF (${WALRUS_ARCH} STREQUAL "x86")
        SET (WALRUS_BUILD_32BIT ON)
        SET (WALRUS_CXXFLAGS ${WALRUS_CXXFLAGS} -m32 -mfpmath=sse -msse -msse2  -mstackrealign)
        SET (WALRUS_LDFLAGS -fPIE -pie -llog -Wl,--gc-sections -m32)
    ELSEIF (${WALRUS_ARCH} STREQUAL "x86_64")
        SET (WALRUS_BUILD_64BIT_LARGE ON)
        SET (WALRUS_LDFLAGS -fPIE -pie -llog -Wl,--gc-sections)
        # bdwgc android amd64 cannot support keeping back ptrs
        SET (WALRUS_THIRDPARTY_CFLAGS ${WALRUS_THIRDPARTY_CFLAGS} -UKEEP_BACK_PTRS -USAVE_CALL_COUNT -UDBG_HDRS_ALL)
    ENDIF()
ELSEIF (${WALRUS_HOST} STREQUAL "darwin" AND ${WALRUS_ARCH} STREQUAL "x64")
    SET (WALRUS_LDFLAGS -lpthread -Wl,-dead_strip)
    SET (WALRUS_BUILD_64BIT_LARGE ON)
    # bdwgc mac cannot support pthread_getattr_np
    SET (WALRUS_THIRDPARTY_CFLAGS ${ESCARGOT_THIRDPARTY_CFLAGS} -UHAVE_PTHREAD_GETATTR_NP -UUSE_GET_STACKBASE_FOR_MAIN)
ELSE()
    MESSAGE (FATAL_ERROR ${WALRUS_HOST} " with " ${WALRUS_ARCH} " is unsupported")
ENDIF()

IF (WALRUS_BUILD_32BIT)
    # 32bit build
    SET (WALRUS_DEFINITIONS ${WALRUS_DEFINITIONS} -DWALRUS_32=1)
ELSEIF (WALRUS_BUILD_64BIT)
    # 64bit build
    SET (WALRUS_DEFINITIONS ${WALRUS_DEFINITIONS} -DWALRUS_64=1 -DWALRUS_USE_32BIT_IN_64BIT)
    SET (WALRUS_THIRDPARTY_CFLAGS ${WALRUS_THIRDPARTY_CFLAGS} -DWALRUS_USE_32BIT_IN_64BIT)
ELSEIF (WALRUS_BUILD_64BIT_LARGE)
    # 64bit build(large)
    SET (WALRUS_DEFINITIONS ${WALRUS_DEFINITIONS} -DWALRUS_64=1)
ELSE()
    MESSAGE (FATAL_ERROR "unsupported mode")
ENDIF()
